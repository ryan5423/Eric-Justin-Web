<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eriju | è¨‚å–®ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.33/dist/lenis.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        :root { --accent: #0f172a; --bg-light: #fdfdfd; }
        body { 
            background-color: var(--bg-light); color: #334155; 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            letter-spacing: -0.01em; padding-top: 80px; overflow-x: hidden;
        }

        /* å…¨ç«™çµ±ä¸€å°è¦½åˆ— */
        .floating-nav { 
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(20px) saturate(160%);
            border: 1px solid rgba(0, 0, 0, 0.05); border-radius: 50px; margin-top: 20px;
            width: 90%; max-width: 1100px; left: 50%; transform: translateX(-50%);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); z-index: 1000;
        }
        #mobile-menu.active { opacity: 1 !important; pointer-events: auto !important; }

        /* ä½¿ç”¨è€…é¸å–® */
        .user-menu {
            opacity: 0; visibility: hidden; transform: scale(0.95) translateY(10px);
            position: absolute; right: 0; top: 60px; width: 240px;
            background: white; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s; z-index: 1001;
        }
        #auth-section:hover .user-menu { opacity: 1; visibility: visible; transform: scale(1) translateY(0); }

        /* è¨‚å–®å¡ç‰‡è¨­è¨ˆ */
        .tab-group { background: #f1f5f9; padding: 4px; border-radius: 16px; display: inline-flex; }
        .tab-btn { padding: 8px 24px; font-size: 11px; font-weight: 900; color: #94a3b8; transition: all 0.4s; border-radius: 12px; letter-spacing: 0.05em; }
        .tab-btn.active { background: white; color: #0f172a; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .order-card { 
            background: #ffffff; border-radius: 32px; border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden;
            box-shadow: 0 4px 30px rgba(0,0,0,0.02);
        }
        .order-card:hover { border-color: rgba(0,0,0,0.08); transform: translateY(-2px); }
        .order-card.active { border-color: #0f172a; }

        .detail-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; opacity: 0; }
        .order-card.active .detail-wrapper { grid-template-rows: 1fr; opacity: 1; }
        .detail-content { overflow: hidden; }

        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-text { font-size: 11px; font-weight: 900; letter-spacing: 0.05em; }

        .action-btn { 
            background: #0f172a; color: white; padding: 16px; border-radius: 20px; 
            font-size: 12px; font-weight: 900; letter-spacing: 0.1em; width: 100%; transition: all 0.3s;
        }
        .action-btn:hover { background: #334155; transform: scale(1.01); }
        .finishing { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <nav class="floating-nav fixed top-0 px-6 md:px-8 h-[70px] flex items-center justify-between">
        <a href="index.html" class="flex items-center group">
            <div class="w-10 h-10 rounded-xl overflow-hidden shadow-sm transition-all group-hover:rotate-6">
                <img src="photo/S__38223874.jpg" alt="Logo" class="w-full h-full object-cover">
            </div>
            <span class="ml-4 text-xl font-black tracking-tighter text-slate-900 uppercase">Eriju</span>
        </a>
        
        <div class="flex items-center gap-4 md:gap-8">
            <div class="hidden md:flex items-center gap-8 text-[13px] font-bold tracking-widest uppercase">
                <a href="catalog.html" class="text-slate-400 hover:text-slate-900 transition">é¸è³¼</a>
                <a href="about.html" class="text-slate-400 hover:text-slate-900 transition">é—œæ–¼</a>
            </div>

            <a href="cart.html" class="text-slate-900 text-xl relative">ğŸ›’
                <span id="cart-dot" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 bg-slate-900 border-2 border-white rounded-full"></span>
            </a>

            <div id="auth-section" class="hidden md:block relative"></div>

            <button onclick="toggleMobileMenu()" class="block md:hidden text-slate-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
    </nav>

    <div id="mobile-menu" class="fixed inset-0 bg-white/95 backdrop-blur-xl z-[2000] flex flex-col items-center justify-center gap-8 opacity-0 pointer-events-none transition-all duration-500">
        <button onclick="toggleMobileMenu()" class="absolute top-8 right-8 text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <div id="user-info-mobile" class="text-center"></div>
        <a href="catalog.html" class="text-4xl font-black text-slate-900 uppercase" onclick="toggleMobileMenu()">é¸è³¼ç³»åˆ—</a>
        <a href="cart.html" class="text-4xl font-black text-slate-900 uppercase" onclick="toggleMobileMenu()">è³¼ç‰©è¢‹</a>
        <button onclick="_supabase.auth.signOut().then(()=>location.reload())" class="mt-8 text-red-400 font-bold uppercase tracking-widest">ç™»å‡ºå¸³è™Ÿ</button>
    </div>

    <main class="max-w-3xl mx-auto px-6 pt-12">
        <div class="mb-12 md:mb-16">
            <p class="text-[10px] font-black tracking-[0.4em] text-slate-300 uppercase mb-4">MANAGEMENT</p>
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
                <h1 class="text-5xl font-black tracking-tighter text-slate-900">æˆ‘çš„è¨‚å–®å­˜æª”</h1>
                <div class="tab-group">
                    <button onclick="switchTab('active')" id="tab-active" class="tab-btn active">é€²è¡Œä¸­</button>
                    <button onclick="switchTab('history')" id="tab-history" class="tab-btn">æ­·å²ç´€éŒ„</button>
                </div>
            </div>
        </div>

        <div id="orders-container" class="space-y-6">
            <div class="animate-pulse space-y-4">
                <div class="h-32 bg-white rounded-[32px]"></div>
                <div class="h-32 bg-white rounded-[32px]"></div>
            </div>
        </div>
    </main>

    <script>
        const _supabase = supabase.createClient('https://oikubhlwdbxrfhifqusn.supabase.co', 'sb_publishable_jwPs6RwbH4W4qg1ttjjZog_BcTN8VJy');
        let allOrders = [];
        let currentView = 'active';

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('active');
            document.body.style.overflow = menu.classList.contains('active') ? 'hidden' : '';
        }

        _supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                handleAuthUI(session);
                fetchData();
                checkCartDot();
            } else {
                window.location.href = 'index.html';
            }
        });

        function handleAuthUI(session) {
            const authSection = document.getElementById('auth-section');
            const userM = document.getElementById('user-info-mobile');
            const avatar = session.user.user_metadata.avatar_url || 'photo/S__38223874.jpg';
            const name = session.user.user_metadata.full_name || 'Premium User';

            authSection.innerHTML = `
                <div class="relative group">
                    <div class="relative cursor-pointer">
                        <img src="${avatar}" class="w-9 h-9 rounded-xl ring-4 ring-white shadow-sm transition-all group-hover:rotate-3">
                    </div>
                    <div class="user-menu p-3">
                        <div class="px-4 py-3 bg-slate-50 rounded-2xl mb-2">
                            <p class="text-slate-900 text-[10px] font-black uppercase tracking-widest truncate">${name}</p>
                        </div>
                        <a href="catalog.html" class="block p-3 text-[11px] font-bold text-slate-600 hover:bg-slate-50 rounded-xl transition-all">âœ¨ æ–°å“ç³»åˆ—</a>
                        <button onclick="_supabase.auth.signOut().then(()=>location.reload())" class="w-full text-left p-3 text-[11px] font-bold text-red-400 hover:bg-red-50 rounded-xl transition-all">ğŸšª ç™»å‡ºå¸³è™Ÿ</button>
                    </div>
                </div>`;
            userM.innerHTML = `<img src="${avatar}" class="w-20 h-20 rounded-2xl mx-auto shadow-xl border-4 border-white mb-2"><p class="font-black text-slate-900">${name}</p>`;
        }

        async function fetchData() {
            const { data, error } = await _supabase.from('orders').select('*').order('created_at', { ascending: false });
            if (!error) { allOrders = data; render(); }
        }

        function switchTab(view) {
            currentView = view;
            document.getElementById('tab-active').classList.toggle('active', view === 'active');
            document.getElementById('tab-history').classList.toggle('active', view === 'history');
            render();
        }

        function render() {
            const container = document.getElementById('orders-container');
            const filtered = allOrders.filter(o => currentView === 'active' ? o.status !== 'completed' : o.status === 'completed');

            if (filtered.length === 0) {
                container.innerHTML = `<div class="py-24 text-center text-slate-300 font-bold uppercase tracking-[0.3em] text-[10px]">å°šç„¡è¨‚å–®ç´€éŒ„</div>`;
                return;
            }

            container.innerHTML = filtered.map(order => {
                const items = order.items || [];
                const firstItem = items[0] || {};
                const statusInfo = getStatusStyle(order.status);
                return `
                <div class="order-card" id="card-${order.id}" onclick="this.classList.toggle('active')">
                    <div class="p-6 md:p-10 flex items-center justify-between cursor-pointer">
                        <div class="flex items-center gap-4 md:gap-8">
                            <div class="relative flex-shrink-0">
                                <img src="${firstItem.image}" onerror="this.src='photo/S__38223874.jpg'" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-[20px] shadow-sm">
                                ${items.length > 1 ? `<div class="absolute -top-2 -right-2 bg-slate-900 text-white text-[9px] w-6 h-6 flex items-center justify-center rounded-full font-black">+${items.length-1}</div>` : ''}
                            </div>
                            <div>
                                <h3 class="font-black text-slate-900 text-lg md:text-xl tracking-tighter mb-1 truncate max-w-[150px] md:max-w-none">${firstItem.name || 'ä½œå“å…§å®¹'}</h3>
                                <div class="flex items-center">
                                    <span class="status-dot ${statusInfo.bg}"></span>
                                    <span class="status-text ${statusInfo.text}">${statusInfo.label}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-slate-900 text-xl md:text-2xl tracking-tighter">NT$ ${order.total_amount.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="detail-wrapper">
                        <div class="detail-content px-6 md:px-10 pb-10">
                            <div class="h-[1px] bg-slate-50 w-full mb-8"></div>
                            <div class="grid md:grid-cols-2 gap-10 mb-10">
                                <div>
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">é…é€è³‡è¨Š</p>
                                    <p class="text-sm font-black text-slate-900">${order.user_name}</p>
                                    <p class="text-xs text-slate-400 mt-2">${order.shipping_address}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">æ¸…å–®</p>
                                    <div class="space-y-2">
                                        ${items.map(i => `<div class="flex justify-between text-xs font-bold"><span class="text-slate-500">${i.name} Ã— ${i.qty}</span><span class="text-slate-900">NT$ ${(i.price * i.qty).toLocaleString()}</span></div>`).join('')}
                                    </div>
                                </div>
                            </div>
                            ${renderAction(order)}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function getStatusStyle(s) {
            const styles = {
                'pending': { label: 'æ’å–®ä¸­', bg: 'bg-amber-400', text: 'text-amber-500' },
                'processing': { label: 'å·¥è—è£½ä½œä¸­', bg: 'bg-blue-500', text: 'text-blue-600' },
                'delivered': { label: 'ç‰©æµé…é€ä¸­', bg: 'bg-green-500', text: 'text-green-600' },
                'completed': { label: 'å·²æ­¸æª”', bg: 'bg-slate-300', text: 'text-slate-400' }
            };
            return styles[s] || { label: s, bg: 'bg-slate-200', text: 'text-slate-400' };
        }

        function renderAction(order) {
            if (order.status === 'delivered') return `<button onclick="event.stopPropagation(); finishOrder('${order.id}')" class="action-btn">ç¢ºèªæ”¶è²¨ä¸¦å­˜æª”</button>`;
            if (order.status === 'completed') return `<p class="text-center text-slate-300 text-[10px] font-black tracking-[0.3em] uppercase py-4">æ­¤è¨‚å–®å·²å®Œæˆæ­¸æª”</p>`;
            return `<div class="text-center py-6 bg-slate-50 rounded-[24px] border border-dashed border-slate-200"><p class="text-slate-400 text-[9px] font-black tracking-[0.4em] uppercase">è·äººæ­£ç‚ºæ‚¨æº–å‚™åŒ…è£¹ä¸­</p></div>`;
        }

        async function finishOrder(id) {
            if (!confirm('ç¢ºèªæ”¶è²¨å—ï¼Ÿ')) return;
            const card = document.getElementById(`card-${id}`);
            card.classList.add('finishing');
            const { error } = await _supabase.from('orders').update({ status: 'completed' }).eq('id', id);
            if (!error) fetchData(); else card.classList.remove('finishing');
        }

        function checkCartDot() {
            if (JSON.parse(localStorage.getItem('ej_cart') || '[]').length > 0) document.getElementById('cart-dot')?.classList.remove('hidden');
        }

        window.addEventListener('DOMContentLoaded', () => {
            const lenis = new Lenis();
            function raf(time) { lenis.raf(time); requestAnimationFrame(raf); }
            requestAnimationFrame(raf);

            gsap.registerPlugin(ScrollTrigger);
            ScrollTrigger.create({
                start: "top -20",
                onEnter: () => gsap.to(".floating-nav", { marginTop: "10px", width: "95%", backgroundColor: "rgba(255,255,255,0.75)", duration: 0.6 }),
                onLeaveBack: () => gsap.to(".floating-nav", { marginTop: "20px", width: "90%", backgroundColor: "rgba(255,255,255,0.4)", duration: 0.6 })
            });
        });
    </script>
    <script>
        window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>