<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç®¡ç† | Eriju Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.33/dist/lenis.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        
        :root { 
            --accent: #0f172a; 
            --bg-light: #fdfdfd;
        }

        body { 
            background-color: var(--bg-light);
            color: #334155;
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            letter-spacing: -0.01em;
        }

        /* é ‚ç´šå°è¦½åˆ— */
        .floating-nav { 
            background: rgba(255, 255, 255, 0.8) !important; 
            backdrop-filter: blur(20px) saturate(160%) !important;
            border: 1px solid rgba(0, 0, 0, 0.05) !important;
            border-radius: 50px !important; margin-top: 20px;
            width: 90%; max-width: 1100px; left: 50%; transform: translateX(-50%);
            z-index: 1000;
        }

        .user-menu {
            opacity: 0; visibility: hidden; transform: scale(0.95) translateY(10px);
            position: absolute; right: 0; top: 60px; width: 240px;
            background: white; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 1001;
        }
        #auth-section:hover .user-menu { opacity: 1; visibility: visible; transform: scale(1) translateY(0); }

        .tab-group { background: #f1f5f9; padding: 4px; border-radius: 16px; display: inline-flex; }
        .tab-btn { 
            padding: 8px 24px; font-size: 12px; font-weight: 900; color: #94a3b8; 
            transition: all 0.4s; border-radius: 12px; letter-spacing: 0.05em;
        }
        .tab-btn.active { background: white; color: #0f172a; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .order-card { 
            background: #ffffff; border-radius: 32px; border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden;
            box-shadow: 0 4px 30px rgba(0,0,0,0.02);
        }
        .order-card:hover { border-color: rgba(0,0,0,0.08); transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.04); }
        .order-card.active { border-color: #0f172a; }

        .detail-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; opacity: 0; }
        .order-card.active .detail-wrapper { grid-template-rows: 1fr; opacity: 1; }
        .detail-content { overflow: hidden; }

        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-text { font-size: 11px; font-weight: 900; letter-spacing: 0.05em; }

        .action-btn { 
            background: #0f172a; color: white; padding: 16px; border-radius: 20px; 
            font-size: 12px; font-weight: 900; letter-spacing: 0.1em; width: 100%;
            transition: all 0.3s;
        }
        .action-btn:hover { background: #334155; transform: scale(1.01); }
        
        .finishing { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="pt-32 pb-20">

    <nav class="floating-nav fixed top-0 h-[70px] px-8 flex items-center justify-between">
        <a href="index.html" class="flex items-center group">
            <div class="w-10 h-10 rounded-xl overflow-hidden shadow-sm transition-all group-hover:rotate-6">
                <img src="photo/S__38223874.jpg" alt="Logo" class="w-full h-full object-cover">
            </div>
            <span class="ml-4 text-xl font-black tracking-tighter text-slate-900 uppercase">Eriju</span>
        </a>
        
        <div class="flex items-center gap-8 text-[13px] font-bold tracking-widest uppercase">
            <a href="catalog.html" class="text-slate-400 hover:text-slate-900 transition">é¸è³¼</a>
            <a href="about.html" class="text-slate-400 hover:text-slate-900 transition">é—œæ–¼</a>
            <div id="auth-section" class="relative"></div>
            <a href="cart.html" class="relative group p-2">
                <span class="text-xl">ğŸ›’</span>
                <span id="cart-dot" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-slate-900 border-2 border-white rounded-full"></span>
            </a>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto px-6">
        <div class="mb-16">
            <p class="text-[10px] font-black tracking-[0.4em] text-slate-300 uppercase mb-4">MANAGEMENT</p>
            <div class="flex items-end justify-between">
                <h1 class="text-5xl font-black tracking-tighter text-slate-900">æˆ‘çš„è¨‚å–®å­˜æª”</h1>
                <div class="tab-group">
                    <button onclick="switchTab('active')" id="tab-active" class="tab-btn active">é€²è¡Œä¸­</button>
                    <button onclick="switchTab('history')" id="tab-history" class="tab-btn">æ­·å²ç´€éŒ„</button>
                </div>
            </div>
        </div>

        <div id="orders-container" class="space-y-6">
            <div class="animate-pulse space-y-4">
                <div class="h-32 bg-white rounded-[32px]"></div>
                <div class="h-32 bg-white rounded-[32px]"></div>
            </div>
        </div>
    </main>

    <script>
        const _supabase = supabase.createClient('https://oikubhlwdbxrfhifqusn.supabase.co', 'sb_publishable_jwPs6RwbH4W4qg1ttjjZog_BcTN8VJy');
        let allOrders = [];
        let currentView = 'active';

        const lenis = new Lenis();
        function raf(time) { lenis.raf(time); requestAnimationFrame(raf); }
        requestAnimationFrame(raf);

        _supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                handleAuthUI(session);
                fetchData();
                checkCartDot();
            } else {
                window.location.href = 'index.html';
            }
        });

        function handleAuthUI(session) {
            const authSection = document.getElementById('auth-section');
            const avatar = session.user.user_metadata.avatar_url || 'photo/S__38223874.jpg';
            authSection.innerHTML = `
                <div class="relative group">
                    <div class="relative cursor-pointer">
                        <img src="${avatar}" class="w-9 h-9 rounded-xl ring-4 ring-white shadow-sm transition-all group-hover:rotate-3">
                        <div class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
                    </div>
                    <div class="user-menu p-3">
                        <div class="px-4 py-3 bg-slate-50 rounded-2xl mb-2">
                            <p class="text-slate-900 text-[10px] font-black uppercase tracking-widest">${session.user.user_metadata.full_name || 'æœƒå“¡'}</p>
                            <p class="text-slate-400 text-[9px] truncate">${session.user.email}</p>
                        </div>
                        <a href="catalog.html" class="flex items-center gap-3 p-3 text-[11px] font-bold text-slate-600 hover:bg-slate-50 rounded-xl transition-all">âœ¨ æ–°å“ç³»åˆ—</a>
                        <button onclick="_supabase.auth.signOut().then(()=>location.reload())" class="w-full text-left flex items-center gap-3 p-3 text-[11px] font-bold text-red-400 hover:bg-red-50 rounded-xl transition-all">ğŸšª ç™»å‡ºå¸³è™Ÿ</button>
                    </div>
                </div>`;
        }

        async function fetchData() {
            const { data, error } = await _supabase.from('orders').select('*').order('created_at', { ascending: false });
            if (!error) { allOrders = data; render(); }
        }

        function switchTab(view) {
            currentView = view;
            document.getElementById('tab-active').classList.toggle('active', view === 'active');
            document.getElementById('tab-history').classList.toggle('active', view === 'history');
            render();
        }

        function render() {
            const container = document.getElementById('orders-container');
            const filtered = allOrders.filter(o => currentView === 'active' ? o.status !== 'completed' : o.status === 'completed');

            if (filtered.length === 0) {
                container.innerHTML = `<div class="py-24 text-center text-slate-300 font-bold uppercase tracking-[0.3em] text-[10px]">å°šç„¡è¨‚å–®ç´€éŒ„</div>`;
                return;
            }

            container.innerHTML = filtered.map(order => {
                const items = order.items || [];
                const firstItem = items[0] || {};
                const statusInfo = getStatusStyle(order.status);

                return `
                <div class="order-card" id="card-${order.id}" onclick="this.classList.toggle('active')">
                    <div class="p-10 flex items-center justify-between cursor-pointer">
                        <div class="flex items-center gap-8">
                            <div class="relative">
                                <img src="${firstItem.image}" onerror="this.src='photo/S__38223874.jpg'" class="w-20 h-20 object-cover rounded-[24px] shadow-sm">
                                ${items.length > 1 ? `<div class="absolute -top-3 -right-3 bg-white text-slate-900 text-[10px] w-7 h-7 flex items-center justify-center rounded-full border border-slate-100 font-black shadow-sm">+${items.length-1}</div>` : ''}
                            </div>
                            <div>
                                <h3 class="font-black text-slate-900 text-xl tracking-tighter mb-1">${firstItem.name || 'ä½œå“å…§å®¹'}</h3>
                                <div class="flex items-center">
                                    <span class="status-dot ${statusInfo.bg}"></span>
                                    <span class="status-text ${statusInfo.text}">${statusInfo.label}</span>
                                    <span class="mx-3 w-[1px] h-3 bg-slate-200"></span>
                                    <span class="text-[10px] text-slate-300 font-bold uppercase tracking-widest">${new Date(order.created_at).toLocaleDateString('zh-TW')}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-slate-900 text-2xl tracking-tighter">NT$ ${order.total_amount.toLocaleString()}</p>
                            <p class="text-[9px] font-bold text-slate-300 uppercase mt-1 tracking-widest">è¨‚å–®ç¸½é¡</p>
                        </div>
                    </div>
                    
                    <div class="detail-wrapper">
                        <div class="detail-content px-10 pb-10">
                            <div class="h-[1px] bg-slate-50 w-full mb-8"></div>
                            <div class="grid md:grid-cols-2 gap-12 mb-10">
                                <div>
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">é…é€è³‡è¨Š</p>
                                    <p class="text-sm font-black text-slate-900">${order.user_name}</p>
                                    <p class="text-xs text-slate-500 mt-1">${order.user_phone}</p>
                                    <p class="text-xs text-slate-400 mt-3 leading-relaxed">${order.shipping_address}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">å•†å“æ¸…å–®</p>
                                    <div class="space-y-3">
                                        ${items.map(i => `
                                            <div class="flex justify-between text-xs font-bold">
                                                <span class="text-slate-500">${i.name} <span class="text-slate-300 font-medium">Ã— ${i.qty}</span></span>
                                                <span class="text-slate-900">NT$ ${(i.price * i.qty).toLocaleString()}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            ${renderAction(order)}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function getStatusStyle(s) {
            const styles = {
                'pending': { label: 'æ’å–®ä¸­', bg: 'bg-amber-400', text: 'text-amber-500' },
                'processing': { label: 'å·¥è—è£½ä½œä¸­', bg: 'bg-blue-500', text: 'text-blue-600' },
                'delivered': { label: 'ç‰©æµé…é€ä¸­', bg: 'bg-green-500', text: 'text-green-600' },
                'completed': { label: 'å·²æ­¸æª”', bg: 'bg-slate-300', text: 'text-slate-400' }
            };
            return styles[s] || { label: s, bg: 'bg-slate-200', text: 'text-slate-400' };
        }

        function renderAction(order) {
            if (order.status === 'delivered') {
                return `<button onclick="event.stopPropagation(); finishOrder('${order.id}')" class="action-btn">ç¢ºèªæ”¶è²¨ä¸¦å­˜æª”</button>`;
            }
            if (order.status === 'completed') {
                return `<p class="text-center text-slate-300 text-[10px] font-black tracking-[0.3em] uppercase py-4">æ­¤è¨‚å–®å·²å®Œæˆä¸¦æ­¸æª”</p>`;
            }
            return `<div class="text-center py-6 bg-slate-50 rounded-[24px] border border-dashed border-slate-200">
                        <p class="text-slate-400 text-[9px] font-black tracking-[0.4em] uppercase">è·äººæ­£ç‚ºæ‚¨æº–å‚™åŒ…è£¹ä¸­</p>
                    </div>`;
        }

        async function finishOrder(id) {
            if (!confirm('ç¢ºèªå®Œæˆæ­¤è¨‚å–®ä¸¦ç§»è‡³å­˜æª”å—ï¼Ÿ')) return;
            const card = document.getElementById(`card-${id}`);
            card.classList.add('finishing');
            const { error } = await _supabase.from('orders').update({ status: 'completed' }).eq('id', id);
            if (!error) {
                setTimeout(() => fetchData(), 400);
            } else {
                card.classList.remove('finishing');
            }
        }

        function checkCartDot() {
            const cart = JSON.parse(localStorage.getItem('ej_cart') || '[]');
            if (cart.length > 0) document.getElementById('cart-dot')?.classList.remove('hidden');
        }
    </script>
</body>
</html>