<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼ç‰©è»Š | EriJu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f5f5f7; color: #1d1d1f; }
        .glass-nav { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-bottom: 0.5px solid #d2d2d7; }
        .cart-item { background: #fff; border-radius: 18px; }
        .rounded-apple { border-radius: 20px; }
        .img-container { width: 80px; height: 80px; background: #f9f9fb; border-radius: 12px; overflow: hidden; flex-shrink: 0; }
        .input-apple { width: 100%; padding: 14px; background: #fff; border: 1px solid #d2d2d7; border-radius: 12px; font-size: 15px; outline-color: #0071e3; }
        .input-apple:focus { border-color: #0071e3; background: #fff; }
    </style>
</head>
<body class="pb-20">

    <nav class="glass-nav fixed top-0 w-full z-50 h-[52px] flex items-center px-6">
        <div class="max-w-screen-xl mx-auto w-full flex justify-between items-center">
            <a href="index.html" class="font-bold text-sm tracking-tight text-black">EriJu</a>
            <a href="catalog.html" class="text-xs text-blue-600 hover:underline">ç¹¼çºŒé¸è³¼</a>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto pt-24 px-6">
        <h1 class="text-3xl md:text-4xl font-bold mb-8 tracking-tight">å›é¡§æ‚¨çš„è³¼ç‰©è¢‹ã€‚</h1>

        <div id="login-alert" class="hidden mb-8 p-4 bg-blue-50 border border-blue-100 rounded-apple flex justify-between items-center">
            <p class="text-sm text-blue-800">ç™»å…¥å¾Œå³å¯å¿«é€Ÿå®Œæˆçµå¸³</p>
            <button onclick="location.href='index.html'" class="text-sm font-bold text-blue-600">å»ç™»å…¥ ></button>
        </div>

        <div id="cart-list" class="space-y-4">
            <div class="py-20 text-center text-gray-400">æ­£åœ¨æª¢æŸ¥æ‚¨çš„é¸è³¼é …ç›®...</div>
        </div>

        <div id="shipping-section" class="mt-12 space-y-6 hidden">
            <h2 class="text-2xl font-bold tracking-tight">å¯„é€è©³æƒ…ã€‚</h2>
            <div class="bg-white p-6 rounded-apple shadow-sm space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase ml-1">æ”¶ä»¶äººå§“å</label>
                    <input type="text" id="cust-name" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººçœŸå¯¦å§“å" class="input-apple">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase ml-1">è¯çµ¡é›»è©±</label>
                    <input type="tel" id="cust-phone" placeholder="ä¾‹å¦‚ï¼š0912345678" class="input-apple">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase ml-1">å®Œæ•´æ”¶ä»¶åœ°å€</label>
                    <textarea id="cust-address" rows="3" placeholder="è«‹è¼¸å…¥åŒ…å«éƒµéå€è™Ÿçš„å®Œæ•´åœ°å€" class="input-apple"></textarea>
                </div>
            </div>
        </div>

        <div id="checkout-section" class="mt-12 space-y-4 hidden">
            <div class="flex justify-between text-gray-500 text-sm">
                <span>å°è¨ˆ</span>
                <span id="subtotal">NT$ 0</span>
            </div>
            <div class="flex justify-between text-gray-500 text-sm">
                <span>é‹è²»</span>
                <span class="text-black">å…é‹è²»</span>
            </div>
            <hr class="border-gray-200 my-4">
            <div class="flex justify-between text-2xl font-bold">
                <span>ç¸½è¨ˆ</span>
                <span id="grand-total" class="text-blue-600">NT$ 0</span>
            </div>

            <button onclick="processOrder()" id="checkout-btn" class="w-full bg-blue-600 text-white py-4 rounded-apple font-bold text-lg mt-8 hover:bg-blue-700 transition shadow-xl shadow-blue-500/20">
                ç¢ºèªçµå¸³
            </button>
        </div>

        <div id="empty-cart" class="hidden py-32 text-center">
            <div class="text-6xl mb-6">ğŸ›’</div>
            <p class="text-gray-400 text-lg mb-8">æ‚¨çš„è³¼ç‰©è¢‹æ˜¯ç©ºçš„ã€‚</p>
            <a href="catalog.html" class="inline-block bg-blue-600 text-white px-10 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition">å»é¸è³¼ä½œå“</a>
        </div>
    </main>

    <script>
        const _supabase = supabase.createClient('https://oikubhlwdbxrfhifqusn.supabase.co', 'sb_publishable_jwPs6RwbH4W4qg1ttjjZog_BcTN8VJy');
        
        // Discord Webhook ç¶²å€
        const DISCORD_WEBHOOK_URL = 'https://discordapp.com/api/webhooks/1459853932724617402/U28uPKZSEqe37V14Z7dPNZ-RDaeSRhL_9113skzOKJ9F1bUDiVvQ2LxGgfx7p0XM6p1h';

        let myCart = [];

        async function initCart() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                document.getElementById('login-alert').classList.remove('hidden');
            } else {
                document.getElementById('cust-name').value = session.user.user_metadata.full_name || '';
            }

            const savedCart = localStorage.getItem('ej_cart');
            if (savedCart && JSON.parse(savedCart).length > 0) {
                myCart = JSON.parse(savedCart);
                renderCart();
            } else {
                showEmpty();
            }
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let total = 0;

            myCart.forEach((item, index) => {
                total += item.price * item.qty;
                const imageUrl = item.image || 'photo/S__38223874.jpg';
                list.innerHTML += `
                    <div class="cart-item p-5 flex gap-5 items-center shadow-sm">
                        <div class="img-container"><img src="${imageUrl}" class="w-full h-full object-cover"></div>
                        <div class="flex-grow">
                            <h3 class="font-bold text-base leading-tight">${item.name}</h3>
                            <div class="flex items-center gap-4 mt-3">
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold">æ•¸é‡: ${item.qty}</span>
                                <button onclick="removeItem(${index})" class="text-xs text-red-500 font-medium">ç§»é™¤é …ç›®</button>
                            </div>
                        </div>
                        <div class="text-right"><p class="font-bold text-gray-900">NT$ ${(item.price * item.qty).toLocaleString()}</p></div>
                    </div>`;
            });

            document.getElementById('subtotal').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('grand-total').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('checkout-section').classList.remove('hidden');
            document.getElementById('shipping-section').classList.remove('hidden');
            document.getElementById('empty-cart').classList.add('hidden');
        }

        function removeItem(index) {
            if(confirm('ç¢ºå®šè¦ç§»é™¤æ­¤å•†å“å—ï¼Ÿ')) {
                myCart.splice(index, 1);
                localStorage.setItem('ej_cart', JSON.stringify(myCart));
                renderCart();
                if(myCart.length === 0) showEmpty();
            }
        }

        function showEmpty() {
            document.getElementById('cart-list').innerHTML = '';
            document.getElementById('checkout-section').classList.add('hidden');
            document.getElementById('shipping-section').classList.add('hidden');
            document.getElementById('empty-cart').classList.remove('hidden');
        }

        async function processOrder() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const address = document.getElementById('cust-address').value;

            if (!name || !phone || !address) {
                alert("è«‹å¡«å¯«å®Œæ•´çš„æ”¶ä»¶è©³æƒ…ã€‚");
                return;
            }

            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { alert("è«‹å…ˆç™»å…¥ã€‚"); return; }

            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨æäº¤è¨‚å–®...";

            const total = myCart.reduce((s, i) => s + (i.price * i.qty), 0);
            const orderData = {
                user_email: session.user.email,
                user_name: name,
                user_phone: phone,
                shipping_address: address,
                items: myCart,
                total_amount: total,
                status: 'pending'
            };

            const { error } = await _supabase.from('orders').insert([orderData]);

            if (error) {
                alert("ä¸‹å–®å¤±æ•—ï¼š" + error.message);
                btn.disabled = false;
                btn.innerText = "ç¢ºèªçµå¸³";
            } else {
                // ç™¼é€ Discord é€šçŸ¥
                await sendDiscordNotification(orderData);
                
                localStorage.removeItem('ej_cart');
                alert("ğŸ‰ è¨‚å–®å·²æäº¤ï¼è·äººå·²æ”¶åˆ°é€šçŸ¥ä¸¦å°‡å„˜é€Ÿè™•ç†ã€‚");
                location.href = "orders.html";
            }
        }

        // --- 2026 Discord Webhook é€šçŸ¥é‚è¼¯ ---
        async function sendDiscordNotification(order) {
            const payload = {
                username: "EJ è¨‚å–®æ©Ÿå™¨äºº",
                embeds: [{
                    title: "ğŸ†• æ”¶åˆ°æ–°è¨‚å–®ï¼",
                    color: 3447003, // ç¶“å…¸è—è‰²
                    fields: [
                        { name: "ğŸ‘¤ å®¢æˆ¶", value: order.user_name, inline: true },
                        { name: "ğŸ“ é›»è©±", value: order.user_phone, inline: true },
                        { name: "ğŸ’° ç¸½é¡", value: `NT$ ${order.total_amount.toLocaleString()}`, inline: false },
                        { name: "ğŸ“ åœ°å€", value: order.shipping_address, inline: false },
                        { name: "ğŸ“¦ å…§å®¹", value: order.items.map(i => `${i.name} x${i.qty}`).join('\n'), inline: false }
                    ],
                    footer: { text: `ä¾†è‡ª Eric Justin Studio â€¢ ${new Date().toLocaleString()}` }
                }]
            };

            try {
                await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                console.error("Discord é€šçŸ¥ç™¼é€å¤±æ•—", e);
            }
        }

        initCart();
    </script>
</body>
</html>